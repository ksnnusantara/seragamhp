<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Aplikasi HP - Koperasi Sigap Nusantara</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- AOS & Fonts & Icons -->
  <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
  <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <!-- jQuery + Select2 + jQuery UI (datepicker) -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css">
  <script src="https://code.jquery.com/ui/1.13.2/jquery-ui.js"></script>
  <style>
    body{font-family:'Poppins',sans-serif;background:linear-gradient(135deg,#fff,#fffef0)}
    .section-hidden{display:none}
    .date-input{position:relative}
    .date-input .ui-datepicker-trigger{position:absolute;right:10px;top:50%;transform:translateY(-50%);background:none;border:none;color:#d4af37;cursor:pointer;z-index:10}
    .select2-container{width:100%!important}
    .warning-box{background-color:#fef3c7;border-left:4px solid #f59e0b;padding:12px;margin-bottom:16px;border-radius:.375rem}
    .loan-item{padding:8px 12px;margin-bottom:8px;background-color:#f9fafb;border-radius:6px;border-left:3px solid #f59e0b}
    .loan-item:last-child{margin-bottom:0}
    .ui-datepicker-trigger{padding:8px;background:none;border:none;cursor:pointer;color:#d4af37;font-size:16px;transition:color .2s}
    .ui-datepicker-trigger:hover{color:#b8941f}
    .ui-datepicker-trigger:focus{outline:none;box-shadow:0 0 0 2px rgba(212,175,55,.3);border-radius:4px}
    .date-input input[readonly]{background-color:#f9fafb;cursor:pointer}
    .whatsapp-link { color: #25D366; text-decoration: none; }
    .whatsapp-link:hover { text-decoration: underline; }
    .masa-cicilan-active { color: #f59e0b; font-weight: 600; }
    .masa-cicilan-complete { color: #10b981; font-weight: 600; }
  </style>
</head>
<body class="font-poppins">
  <!-- Loading Spinner -->
  <div id="loadingSpinner" class="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 hidden">
    <div class="bg-white/95 p-8 rounded-2xl shadow-2xl text-center max-w-sm mx-4">
      <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-yellow-500 mx-auto mb-4"></div>
      <p class="text-lg font-semibold text-gray-800">Memproses...</p>
      <p class="text-sm text-gray-600 mt-2">Harap tunggu sebentar</p>
    </div>
  </div>

  <!-- Toast -->
  <div id="toast" class="fixed bottom-4 left-1/2 -translate-x-1/2 hidden px-4 py-2 rounded-lg bg-slate-900 text-white text-sm shadow-lg"></div>

  <!-- Modal Konfirmasi -->
  <div id="confirmModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 hidden p-4">
    <div class="bg-white/95 rounded-2xl shadow-2xl p-8 w-full max-w-md" data-aos="fade-up">
      <div class="flex justify-between items-center mb-6">
        <h3 class="text-xl font-bold text-gray-800"><i class="fas fa-exclamation-triangle text-yellow-500 mr-2"></i>Konfirmasi</h3>
        <button onclick="closeConfirmModal()" class="text-gray-500 hover:text-gray-700 hover:bg-gray-100 p-2 rounded-full"><i class="fas fa-times text-xl"></i></button>
      </div>
      <div class="mb-6">
        <p class="text-gray-700 mb-4">NPK ini masih memiliki angsuran HP yang aktif. Apakah Anda yakin ingin melanjutkan pengajuan?</p>
        <div id="activeLoansInfo" class="bg-yellow-50 p-3 rounded-lg text-sm text-gray-700 max-h-60 overflow-y-auto"></div>
      </div>
      <div class="flex justify-end gap-3 pt-4">
        <button type="button" onclick="closeConfirmModal()" class="px-6 py-3 border-2 border-gray-300 rounded-xl text-gray-700 hover:bg-gray-50">Batal</button>
        <button type="button" onclick="confirmProceed()" class="px-6 py-3 bg-yellow-500 hover:bg-yellow-600 text-white rounded-xl font-medium">Lanjutkan</button>
      </div>
    </div>
  </div>

  <!-- Modal Ubah Data (tanpa input Nama & Instalasi) -->
  <div id="statusModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 hidden p-4">
    <div class="bg-white/95 rounded-2xl shadow-2xl p-8 w-full max-w-md" data-aos="fade-up">
      <div class="flex justify-between items-center mb-6">
        <h3 class="text-xl font-bold text-gray-800"><i class="fas fa-edit text-yellow-500 mr-2"></i>Ubah Data HP</h3>
        <button onclick="closeStatusModal()" class="text-gray-500 hover:text-gray-700 hover:bg-gray-100 p-2 rounded-full"><i class="fas fa-times text-xl"></i></button>
      </div>
      <form id="statusForm" class="space-y-4">
        <input type="hidden" id="statusId">
        <input type="hidden" id="statusRowNumber">
        <div>
          <label class="block text-gray-700 font-semibold mb-2">NPK:</label>
          <input type="text" id="statusNpk" readonly class="w-full px-4 py-3 bg-gray-50 border-2 border-gray-200 rounded-xl font-mono">
        </div>
        <div>
          <label class="block text-gray-700 font-semibold mb-2">No. Telepon:</label>
          <input type="text" id="statusNotelp" readonly class="w-full px-4 py-3 bg-gray-50 border-2 border-gray-200 rounded-xl">
        </div>
        <div>
          <label class="block text-gray-700 font-semibold mb-2">Tipe HP:</label>
          <input type="text" id="statusTipeHp" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl">
        </div>
        <div>
          <label class="block text-gray-700 font-semibold mb-2">Alamat:</label>
          <textarea id="statusAlamat" rows="2" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl"></textarea>
        </div>
        <div>
          <label class="block text-gray-700 font-semibold mb-2">Keterangan:</label>
          <textarea id="statusKeterangan" rows="2" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl"></textarea>
        </div>
        <div>
          <label class="block text-gray-700 font-semibold mb-2">Tanggal:</label>
          <div class="date-input">
            <input type="text" id="statusTanggal" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl" placeholder="dd/mm/yyyy" readonly>
            <button type="button" class="ui-datepicker-trigger"><i class="fas fa-calendar-alt"></i></button>
          </div>
        </div>
        <div>
          <label class="block text-gray-700 font-semibold mb-2">Cicilan:</label>
          <input type="text" id="statusCicilan" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl">
        </div>
        <div>
          <label class="block text-gray-700 font-semibold mb-2">Status Baru:</label>
          <select id="newStatus" required class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl">
            <option value="">-- Pilih Status --</option>
            <option value="VERIFIKASI">VERIFIKASI</option>
            <option value="OK">OK</option>
            <option value="NO ACC">NO ACC</option>
            <option value="CANCEL">CANCEL</option>
          </select>
        </div>
        <div class="flex justify-end gap-3 pt-4">
          <button type="button" onclick="closeStatusModal()" class="px-6 py-3 border-2 border-gray-300 rounded-xl text-gray-700 hover:bg-gray-50">Batal</button>
          <button type="submit" class="px-6 py-3 bg-yellow-500 hover:bg-yellow-600 text-white rounded-xl font-medium"><i class="fas fa-save mr-2"></i>Simpan</button>
        </div>
      </form>
    </div>
  </div>

  <div class="container mx-auto max-w-6xl py-8 px-4 min-h-screen">
    <div class="flex items-center justify-between mb-8 flex-wrap gap-4">
      <h2 class="text-2xl md:text-3xl font-bold text-gray-800"><i class="fas fa-mobile-alt text-yellow-500 mr-3"></i>Aplikasi HP Karyawan</h2>
      <a href="index.html" class="px-6 py-3 rounded-xl bg-yellow-500 text-white hover:bg-yellow-600"><i class="fas fa-home mr-2"></i>Menu Utama</a>
    </div>

    <!-- Menu -->
    <div id="menuSelection" class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8" data-aos="fade-up">
      <div onclick="showInputSection()" class="p-6 rounded-xl bg-white border hover:shadow cursor-pointer">
        <div class="w-16 h-16 rounded-full bg-yellow-500 text-white flex items-center justify-center mb-3"><i class="fas fa-plus-circle text-3xl"></i></div>
        <h3 class="text-xl font-bold text-gray-800 mb-1">Input Data HP</h3>
        <p class="text-gray-600">Menambahkan data HP karyawan</p>
      </div>
      <div onclick="showSearchSection()" class="p-6 rounded-xl bg-white border hover:shadow cursor-pointer">
        <div class="w-16 h-16 rounded-full bg-yellow-500 text-white flex items-center justify-center mb-3"><i class="fas fa-search text-3xl"></i></div>
        <h3 class="text-xl font-bold text-gray-800 mb-1">Cari Data by NPK</h3>
        <p class="text-gray-600">Melihat riwayat berdasarkan NPK</p>
      </div>
    </div>

    <!-- Input -->
    <section id="inputSection" class="bg-white rounded-2xl shadow p-4 md:p-6 mb-6 section-hidden">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-xl font-semibold text-slate-800">Input Data Baru</h2>
        <button onclick="backToMenu()" class="px-6 py-3 rounded-xl bg-yellow-500 text-white hover:bg-yellow-600"><i class="fas fa-arrow-left mr-2"></i>Kembali</button>
      </div>

      <div id="warningContainer" class="warning-box hidden">
        <div class="flex items-start">
          <i class="fas fa-exclamation-triangle text-yellow-600 mt-1 mr-2"></i>
          <div>
            <p class="font-medium text-yellow-800">Peringatan</p>
            <p id="warningMessage" class="text-yellow-700 text-sm"></p>
            <div id="activeLoansList" class="mt-2 space-y-2"></div>
          </div>
        </div>
      </div>

      <form id="formInput" class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div>
          <label class="block text-sm font-medium text-slate-600 mb-1">Tanggal</label>
          <div class="date-input">
            <input id="inTanggal" type="text" class="w-full border rounded-xl px-3 py-2" placeholder="dd/mm/yyyy" readonly required>
            <button type="button" class="ui-datepicker-trigger"><i class="fas fa-calendar-alt"></i></button>
          </div>
        </div>
        <div>
          <label class="block text-sm font-medium text-slate-600 mb-1">NPK</label>
          <input id="inNpk" type="text" class="w-full border rounded-xl px-3 py-2" required>
          <p id="npkWarning" class="text-xs text-rose-600 mt-1 hidden"></p>
        </div>
        <div>
          <label class="block text-sm font-medium text-slate-600 mb-1">No. Telp</label>
          <input id="inNotelp" type="tel" class="w-full border rounded-xl px-3 py-2" placeholder="08xxxxxxxxxx">
        </div>
        <div>
          <label class="block text-sm font-medium text-slate-600 mb-1">Cicilan</label>
          <input id="inCicilan" type="text" class="w-full border rounded-xl px-3 py-2" placeholder="Contoh: 12x / 500.000">
        </div>
        <div>
          <label class="block text-sm font-medium text-slate-600 mb-1">Tipe HP</label>
          <select id="inTipehp" class="w-full border rounded-xl px-3 py-2"></select>
        </div>
        <div>
          <label class="block text-sm font-medium text-slate-600 mb-1">Status</label>
          <select id="inStatus" class="w-full border rounded-xl px-3 py-2">
            <option value="">- Pilih -</option>
            <option>OK</option>
            <option>CANCEL</option>
            <option>NO ACC</option>
            <option>VERIFIKASI</option>
          </select>
        </div>
        <div class="md:col-span-3">
          <label class="block text-sm font-medium text-slate-600 mb-1">Alamat Kirim</label>
          <input id="inAlamat" type="text" class="w-full border rounded-xl px-3 py-2" placeholder="Alamat lengkap">
        </div>
        <div class="md:col-span-3">
          <label class="block text-sm font-medium text-slate-600 mb-1">Keterangan</label>
          <textarea id="inKet" rows="2" class="w-full border rounded-xl px-3 py-2" placeholder="Catatan tambahan"></textarea>
        </div>

        <div class="md:col-span-3 flex items-center">
          <input type="checkbox" id="ignoreActiveLoan" class="mr-2 h-5 w-5 text-yellow-600 rounded focus:ring-yellow-500">
          <label for="ignoreActiveLoan" class="text-sm font-medium text-slate-700">Lanjutkan meskipun ada angsuran aktif</label>
        </div>

        <div class="md:col-span-3 flex gap-2 items-center">
          <button id="btnSimpan" type="submit" class="px-4 py-2 rounded-xl bg-yellow-500 text-white hover:bg-yellow-600 disabled:opacity-50 disabled:cursor-not-allowed">Simpan</button>
          <button type="button" onclick="resetForm()" class="px-4 py-2 rounded-xl border border-slate-300 text-slate-700 hover:bg-slate-50">Reset</button>
          <span id="msgInput" class="text-sm text-slate-500"></span>
        </div>
      </form>
    </section>

    <!-- Cari -->
    <section id="searchSection" class="bg-white rounded-2xl shadow p-4 md:p-6 mb-6 section-hidden">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-xl font-semibold text-slate-800">Cari Data by NPK</h2>
        <button onclick="backToMenu()" class="px-6 py-3 rounded-xl bg-yellow-500 text-white hover:bg-yellow-600"><i class="fas fa-arrow-left mr-2"></i>Kembali</button>
      </div>
      <form id="formCari" class="grid grid-cols-1 md:grid-cols-3 gap-3 items-end">
        <div>
          <label class="block text-sm font-medium text-slate-600 mb-1">NPK</label>
          <input id="npkCari" type="text" class="w-full border rounded-xl px-3 py-2 focus:ring-2 focus:ring-yellow-500 outline-none" placeholder="Masukkan NPK..." required>
        </div>
        <div class="md:col-span-2 flex gap-2">
          <button type="submit" class="px-4 py-2 rounded-xl bg-yellow-500 text-white hover:bg-yellow-600">Cari</button>
          <button type="button" id="btnReset" class="px-4 py-2 rounded-xl border border-slate-300 text-slate-700 hover:bg-slate-50">Reset</button>
          <button type="button" onclick="refreshMasaCicilan()" class="px-4 py-2 rounded-xl bg-green-500 text-white hover:bg-green-600">
            <i class="fas fa-sync-alt mr-1"></i> Refresh Masa Cicilan
          </button>
        </div>
      </form>
      <p id="infoCari" class="text-sm text-slate-500 mt-2 hidden"></p>
    </section>

    <!-- Hasil -->
    <section id="resultSection" class="bg-white rounded-2xl shadow p-4 md:p-6 mb-6 section-hidden">
      <div class="flex items-center justify-between mb-3">
        <h2 class="text-xl font-semibold text-slate-800">Hasil Pencarian</h2>
        <div class="text-sm text-slate-500" id="countRows"></div>
      </div>
      <div class="overflow-x-auto">
        <table class="min-w-full border border-slate-200 rounded-xl overflow-hidden" id="tblData">
          <thead class="bg-slate-100 text-slate-700">
            <tr>
              <th class="px-2 py-1">#</th>
              <th class="px-2 py-1">ID</th>
              <th class="px-2 py-1">Tanggal</th>
              <th class="px-2 py-1">NPK</th>
              <th class="px-2 py-1">Nama</th>
              <th class="px-2 py-1">No. Telp</th>
              <th class="px-2 py-1">Instalasi</th>
              <th class="px-2 py-1">Cicilan</th>
              <th class="px-2 py-1">Tipe HP</th>
              <th class="px-2 py-1">Alamat Kirim</th>
              <th class="px-2 py-1">Keterangan</th>
              <th class="px-2 py-1">Status</th>
              <th class="px-2 py-1">Masa Cicilan</th>
              <th class="px-2 py-1">Aksi</th>
            </tr>
          </thead>
          <tbody id="tbody" class="divide-y"></tbody>
        </table>
      </div>
    </section>
  </div>

  <script>
    // ===== ENDPOINT (DISAMAKAN DENGAN LINK WEB-APP TERBARU) =====
    const ENDPOINT = 'https://script.google.com/macros/s/AKfycbxHylq0kuwja-7FQgHwYas-bh9GUUKChEPZ6stylR37gBWtqyFDKe7OsZCov2aoUmPi/exec';

    // ===== Toast & Spinner =====
    const toast = (msg, ok=true) => {
      const t = document.getElementById('toast');
      t.textContent = msg;
      t.className = "fixed bottom-4 left-1/2 -translate-x-1/2 px-4 py-2 rounded-lg text-sm shadow-lg " + (ok ? "bg-yellow-600 text-white" : "bg-rose-600 text-white");
      t.style.opacity = 1; t.style.display = 'block';
      setTimeout(()=>{ t.style.opacity = 0; setTimeout(()=>t.style.display='none', 300) }, 2000);
    };
    const showSpinner = ()=>document.getElementById('loadingSpinner').classList.remove('hidden');
    const hideSpinner = ()=>document.getElementById('loadingSpinner').classList.add('hidden');
    const esc = s => (s ?? "").toString();

    // ===== Tanggal Helpers (DD/MM/YYYY) =====
    function fmtDDMMYYYY(d){
      const dd=String(d.getDate()).padStart(2,'0');
      const mm=String(d.getMonth()+1).padStart(2,'0');
      const yy=d.getFullYear();
      return `${dd}/${mm}/${yy}`;
    }
    function formatDateToDDMMYYYY(val){
      if(!val) return "";
      if(typeof val==='string' && val.includes('/')) {
        const [d,m,y]=val.split('/');
        if(d&&m&&y) return `${d.padStart(2,'0')}/${m.padStart(2,'0')}/${y}`;
      }
      const d=new Date(val);
      if(isNaN(d)) return "";
      return fmtDDMMYYYY(d);
    }
    function convertDateForSorting(dateStr) {
      if (!dateStr) return "";
      const parts = dateStr.split('/');
      if (parts.length !== 3) return dateStr;
      return parts[2] + parts[1] + parts[0]; // YYYYMMDD
    }

    // ===== Katalog & Status =====
    const tipeHpOptions = ["", "VIVO Y29 6/128", "VIVO Y29 8/128", "VIVO Y29 8/256", "Y19S PRO 4/64 GB", "Y19S PRO 4/128 GB", "Y19S PRO 6/128 GB", "REDMI 14C 6/128", "REDMI 14C 8/256", "REDMI NOTE 14 8/128", "REDMI NOTE 14 8/256", "REDMI NOTE 14 8/256 5G", "REDMI NOTE 14 12/512 5G", "REDMI 13 8/128", "REDMI 13 8/256", "REDMI POCO PAD 8/256", "OPPO A60 8/256", "OPPO A3X 6/128", "REALME C75 8/128", "REALME C75 8/256", "REALME NOTE 60 6/128", "SAMSUNG A06 4/64", "SAMSUNG A06 4/128", "SAMSUNG A06 6/128", "SAMSUNG A16 8/128", "SAMSUNG A16 8/256", "SAMSUNG A16 8/256 5G", "SMART 10 4/128 GB", "SMART 10 PLUS 8/128 GB", "HOT 60i 8/256 GB", "HOT 60 PRO 8/256 GB", "INFINIX HOT 50 PRO+ 8/256", "TECNO SPARK GO 1 4/128", "POVA 7 8/128 GB", "POVA 7 8/256 GB", "CAMON 40 8/256 GB", "ADVAN TAB VX LITE 6/128GB"];
    const statusList = ["", "OK", "CANCEL", "NO ACC", "VERIFIKASI"];

    // ===== Nav Section =====
    function showInputSection(){
      document.getElementById('menuSelection').classList.add('section-hidden');
      document.getElementById('inputSection').classList.remove('section-hidden');
      document.getElementById('searchSection').classList.add('section-hidden');
      document.getElementById('resultSection').classList.add('section-hidden');
    }
    function showSearchSection(){
      document.getElementById('menuSelection').classList.add('section-hidden');
      document.getElementById('inputSection').classList.add('section-hidden');
      document.getElementById('searchSection').classList.remove('section-hidden');
      document.getElementById('resultSection').classList.remove('section-hidden');
    }
    function backToMenu(){
      document.getElementById('menuSelection').classList.remove('section-hidden');
      document.getElementById('inputSection').classList.add('section-hidden');
      document.getElementById('searchSection').classList.add('section-hidden');
      document.getElementById('resultSection').classList.add('hidden');
    }
    function resetForm(){
      document.getElementById('formInput').reset();
      $("#inTanggal").val(fmtDDMMYYYY(new Date()));
      $('#inTipehp').val(null).trigger('change');
      document.getElementById('msgInput').textContent='';
      document.getElementById('npkWarning').classList.add('hidden');
      document.getElementById('npkWarning').textContent='';
      document.getElementById('warningContainer').classList.add('hidden');
      document.getElementById('btnSimpan').disabled=false;
    }
    function closeStatusModal(){ document.getElementById('statusModal').classList.add('hidden'); }
    function closeConfirmModal(){ document.getElementById('confirmModal').classList.add('hidden'); }
    function confirmProceed(){
      document.getElementById('confirmModal').classList.add('hidden');
      document.getElementById('ignoreActiveLoan').checked = true;
      document.getElementById('btnSimpan').disabled = false;
      document.getElementById('btnSimpan').click();
    }

    // ===== Deteksi aktif: perhatikan status =====
    function isMasaCicilanAktif(val, status){
      if(!val) return false;
      const s = String(val).trim().toLowerCase();
      if(!s) return false;

      const m = s.match(/^(\d+)\s*\/\s*(\d+)/);
      if (m) {
        const a = parseInt(m[1],10), b = parseInt(m[2],10);
        if (a === b && String(status).toUpperCase() === 'OK') return false;
      }
      if (s.includes('lunas') || s.includes('selesai')) return false;

      const num = parseInt(s.replace(/[^\d]/g,''),10);
      if (!isNaN(num)) return num > 0;

      if (s.includes('bulan')) return true;
      return false;
    }

    function isCicilanAktif(val, status){
      if(!val) return false;
      const s = String(val).trim().toLowerCase();

      const m = s.match(/^(\d+)\s*\/\s*(\d+)/);
      if (m) {
        const a = parseInt(m[1],10), b = parseInt(m[2],10);
        if (a === b && String(status).toUpperCase() === 'OK') return false;
        if (a < b) return true;
      }
      return s.includes('x') && !s.includes('lunas');
    }

    // ===== Cek NPK pada input (otomatis) =====
    let npkCheckTimer = null;
    let activeLoansData = [];

    async function cekNpkSaatInput(){
      const npk = document.getElementById('inNpk').value.trim();
      const warn = document.getElementById('npkWarning');
      const warningContainer = document.getElementById('warningContainer');
      const warningMessage = document.getElementById('warningMessage');
      const activeLoansList = document.getElementById('activeLoansList');
      const ignoreCheckbox = document.getElementById('ignoreActiveLoan');
      const btn = document.getElementById('btnSimpan');

      warn.classList.add('hidden');
      warn.textContent='';
      warningContainer.classList.add('hidden');
      activeLoansList.innerHTML = '';
      btn.disabled=false;

      if(!npk) return;

      try{
        const url = `${ENDPOINT}?action=getData&npk=${encodeURIComponent(npk)}`;
        const res = await fetch(url, {method:'GET'});
        const json = await res.json();
        if(json.status!=='success'){ return; }
        const data = Array.isArray(json.data)?json.data:[];
        const aktif = data.filter(it=>{
          const st = String(it.status||'').toUpperCase();
          const statusAktif = (st==='OK'||st==='VERIFIKASI');
          const cicilanAktif = isCicilanAktif(it.cicilan, it.status);
          const masaAktif = isMasaCicilanAktif(it.masaCicilan, it.status);
          return statusAktif && (cicilanAktif || masaAktif);
        });
        aktif.sort((a,b)=>convertDateForSorting(a.tanggal).localeCompare(convertDateForSorting(b.tanggal)));
        activeLoansData = aktif;

        if(aktif.length && !ignoreCheckbox.checked){
          btn.disabled = true;

          const loanDetails = aktif.map((it,i)=>`
            <div class="loan-item">
              <div class="font-medium">${i+1}. Tipe: ${esc(it.tipehp)||'-'}</div>
              <div class="text-xs mt-1">Cicilan: ${esc(it.cicilan)||'-'}, Masa Angsuran: ${esc(it.masaCicilan)||'-'}, Status: ${esc(it.status)||'-'}</div>
            </div>`).join('');
          activeLoansList.innerHTML = loanDetails;

          warningMessage.textContent = `NPK ini masih memiliki ${aktif.length} angsuran HP yang aktif. Centang opsi "Lanjutkan meskipun ada angsuran aktif" jika ingin melanjutkan pengajuan.`;
          warningContainer.classList.remove('hidden');

          toast('Tidak bisa pengajuan: masih ada angsuran HP yang belum selesai', false);
        }
      }catch(err){
        console.warn('Cek NPK gagal:', err);
      }
    }

    // ===== Submit INPUT =====
    async function handleFormSubmit(e){
      e.preventDefault();
      const btn = document.getElementById('btnSimpan');
      const ignoreCheckbox = document.getElementById('ignoreActiveLoan');

      if(btn.disabled && !ignoreCheckbox.checked){
        const sortedLoans = [...activeLoansData].sort((a,b)=>convertDateForSorting(a.tanggal).localeCompare(convertDateForSorting(b.tanggal)));
        document.getElementById('activeLoansInfo').innerHTML = sortedLoans.map((it,i)=>`
          <div class="loan-item">
            <div class="font-medium">${i+1}. Tipe: ${esc(it.tipehp)||'-'}</div>
            <div class="text-xs mt-1">Cicilan: ${esc(it.cicilan)||'-'}, Masa: ${esc(it.masaCicilan)||'-'}, Status: ${esc(it.status)||'-'}</div>
          </div>`).join('');
        document.getElementById('confirmModal').classList.remove('hidden');
        return;
      }

      showSpinner();
      const tanggal = formatDateToDDMMYYYY(document.getElementById('inTanggal').value);
      const qs = new URLSearchParams({
        tanggal,
        npk: document.getElementById('inNpk').value.trim(),
        notelp: document.getElementById('inNotelp').value.trim(),
        cicilan: document.getElementById('inCicilan').value.trim(),
        tipehp: $('#inTipehp').val() || '',
        alamat: document.getElementById('inAlamat').value.trim(),
        keterangan: document.getElementById('inKet').value.trim(),
        status: document.getElementById('inStatus').value
      });
      if(!qs.get('tanggal') || !qs.get('npk')){
        toast('Tanggal & NPK wajib diisi', false);
        hideSpinner();
        return;
      }

      if(!ignoreCheckbox.checked){
        try{
          const npk = qs.get('npk');
          const chkRes = await fetch(`${ENDPOINT}?action=getData&npk=${encodeURIComponent(npk)}`, {method:'GET'});
          const chkJson = await chkRes.json();
          if(chkJson.status==='success'){
            const data = chkJson.data||[];
            const hasAktif = data.some(it=>{
              const st = String(it.status||'').toUpperCase();
              const statusAktif = (st==='OK'||st==='VERIFIKASI');
              return statusAktif && (isCicilanAktif(it.cicilan, it.status) || isMasaCicilanAktif(it.masaCicilan, it.status));
            });
            if(hasAktif){
              hideSpinner();
              toast('Tidak bisa pengajuan: masih ada angsuran HP yang belum selesai', false);
              document.getElementById('btnSimpan').disabled = true;
              const warn = document.getElementById('npkWarning');
              warn.textContent = 'Masih ada angsuran aktif. Selesaikan terlebih dahulu.';
              warn.classList.remove('hidden');
              return;
            }
          }
        }catch(err){
          console.warn('Error checking active loans:', err);
        }
      }

      try{
        const res = await fetch(`${ENDPOINT}?${qs.toString()}`, {method:'GET'});
        const json = await res.json();
        const el = document.getElementById('msgInput');
        if(json.status==='success'){
          el.textContent='✓ Tersimpan';
          el.className='text-sm text-emerald-600';
          toast('Data baru tersimpan');
          resetForm();
        }else{
          el.textContent='Gagal simpan: '+(json.message||'');
          el.className='text-sm text-rose-600';
          toast('Gagal simpan data', false);
        }
      }catch(err){
        toast('Error simpan: '+err.message, false);
      }
      hideSpinner();
    }

    // ===== Refresh Masa Cicilan =====
    async function refreshMasaCicilan() {
      showSpinner();
      try {
        const res = await fetch(`${ENDPOINT}?action=refreshAll`, {method:'GET'});
        const json = await res.json();
        if(json.status === 'success') {
          toast('Masa cicilan berhasil diperbarui');
          const npk = document.getElementById('npkCari').value.trim();
          if(npk) { await loadData(npk); }
        } else {
          toast('Gagal refresh masa cicilan: ' + (json.message || ''), false);
        }
      } catch(err) {
        toast('Error refresh masa cicilan: ' + err.message, false);
      }
      hideSpinner();
    }

    // ===== Pencarian & Tabel =====
    async function handleSearchSubmit(e){
      e.preventDefault();
      const npk = document.getElementById('npkCari').value.trim();
      if(!npk){ toast('NPK wajib diisi', false); return; }
      showSpinner();
      await loadData(npk);
      hideSpinner();
    }
    function handleSearchReset(){
      document.getElementById('npkCari').value='';
      document.getElementById('tbody').innerHTML='';
      document.getElementById('countRows').textContent='';
      document.getElementById('infoCari').classList.add('hidden');
    }
    async function loadData(npk){
      try{
        const url = `${ENDPOINT}?action=getData&npk=${encodeURIComponent(npk)}`;
        const res = await fetch(url,{method:'GET'});
        const json = await res.json();
        if(json.status!=='success'){ toast(json.message||'Gagal ambil data', false); return; }
        renderTable(json.data||[]);
        document.getElementById('infoCari').classList.remove('hidden');
        document.getElementById('infoCari').textContent=`Menampilkan data untuk NPK: ${npk}`;
      }catch(err){ toast('Gagal memuat data: '+err.message,false); }
    }
    function renderTable(rows){
      const tb=document.getElementById('tbody'); tb.innerHTML='';
      document.getElementById('countRows').textContent=`${rows.length} baris`;
      rows.forEach((r,i)=>{
        const tr=document.createElement('tr'); tr.className='hover:bg-slate-50';
        const tanggalId=`tgl_${i}_${Date.now()}`; const tipeId=`tipe_${i}_${Date.now()}`; const statusId=`sts_${i}_${Date.now()}`;
        const formattedDate=formatDateToDDMMYYYY(r.tanggal);

        let notelpHtml = esc(r.notelp || '');
        if (r.notelp_link) {
          notelpHtml = `<a href="${r.notelp_link}" target="_blank" class="whatsapp-link">${esc(r.notelp || '')} <i class="fab fa-whatsapp"></i></a>`;
        }

        let masaCicilanHtml = esc(r.masaCicilan || '');
        if (r.masaCicilan) {
          if (r.masaCicilan.includes('LENGKAP') || r.masaCicilan.toLowerCase().includes('lunas')) {
            masaCicilanHtml = `<span class="masa-cicilan-complete">${masaCicilanHtml}</span>`;
          } else if (r.masaCicilan.includes('Sisa')) {
            masaCicilanHtml = `<span class="masa-cicilan-active">${masaCicilanHtml}</span>`;
          }
        }

        tr.innerHTML = `
          <td class="px-2 py-1 text-sm text-slate-600">${i+1}</td>
          <td class="px-2 py-1 text-sm">${esc(r.id)}</td>
          <td class="px-2 py-1">
            <div class="date-input">
              <input type="text" id="${tanggalId}" class="border rounded px-2 py-1 w-32" value="${formattedDate}" placeholder="dd/mm/yyyy" readonly>
              <button type="button" class="ui-datepicker-trigger"><i class="fas fa-calendar-alt"></i></button>
            </div>
          </td>
          <td class="px-2 py-1 text-sm">${esc(r.npk)}</td>
          <td class="px-2 py-1 text-sm">${esc(r.nama || '')}</td>
          <td class="px-2 py-1">${notelpHtml}</td>
          <td class="px-2 py-1 text-sm">${esc(r.instalasi || '')}</td>
          <td class="px-2 py-1"><input type="text" class="cicilanSel border rounded px-2 py-1 w-32" value="${esc(r.cicilan)}"></td>
          <td class="px-2 py-1"><select id="${tipeId}" class="tipeSel border rounded px-2 py-1 w-44"></select></td>
          <td class="px-2 py-1"><input type="text" class="alamatSel border rounded px-2 py-1 w-64" value="${esc(r.alamat)}"></td>
          <td class="px-2 py-1"><input type="text" class="ketSel border rounded px-2 py-1 w-64" value="${esc(r.keterangan)}"></td>
          <td class="px-2 py-1"><select id="${statusId}" class="statusSel border rounded px-2 py-1 w-40"></select></td>
          <td class="px-2 py-1 text-sm">${masaCicilanHtml}</td>
          <td class="px-2 py-1">
            <button class="btnUpdate px-3 py-1 rounded bg-yellow-500 text-white hover:bg-yellow-600">Update</button>
          </td>`;
        document.getElementById('tbody').appendChild(tr);

        // Datepicker untuk kolom tanggal (read-only di backend update)
        $(`#${tanggalId}`).datepicker({
          dateFormat:"dd/mm/yy",
          changeMonth:true,
          changeYear:true,
          yearRange:"2020:2030",
          showOn: "button",
          buttonText: ""
        });

        // Isi & aktifkan Select2 tipe HP
        const $tipe=$(`#${tipeId}`);
        $tipe.html(tipeHpOptions.map(v=>`<option ${v===esc(r.tipehp)?"selected":""}>${v}</option>`).join(''));
        $tipe.select2({tags:true,width:'100%',placeholder:"Pilih / ketik",createTag:(p)=>({id:p.term,text:p.term,newOption:true})});

        // Isi status
        const selStatus=document.getElementById(statusId);
        selStatus.innerHTML = statusList.map(s=>`<option ${s===esc(r.status)?"selected":""}>${s}</option>`).join('');

        // Tombol Update → hanya kirim field yang diizinkan backend
        tr.querySelector('.btnUpdate').addEventListener('click', async ()=>{
          showSpinner();
          const payload = {
            action:'updateData',
            id: r.id,                    // update per-baris (tepat sasaran)
            npk: r.npk,                  // kirim juga npk (aman)
            cicilan: tr.querySelector('.cicilanSel').value,
            tipehp: $tipe.val(),
            alamat: tr.querySelector('.alamatSel').value,
            keterangan: tr.querySelector('.ketSel').value,
            status: selStatus.value
          };
          await doUpdate(payload);
          hideSpinner();
        });
      });

      if(rows.length===0){
        const tr=document.createElement('tr');
        tr.innerHTML=`<td colspan="14" class="px-3 py-6 text-center text-slate-500">Belum ada data</td>`;
        document.getElementById('tbody').appendChild(tr);
      }
    }

    async function doUpdate(payload){
      try{
        const fd = new URLSearchParams();
        Object.entries(payload).forEach(([k,v])=>{ if(v!==undefined&&v!==null) fd.append(k,v); });
        const res = await fetch(ENDPOINT,{
          method:'POST',
          headers:{'Content-Type':'application/x-www-form-urlencoded;charset=UTF-8'},
          body:fd.toString()
        });
        const json = await res.json();
        if(json.status==='success'){ toast('Berhasil update data'); }
        else { toast(json.message||'Gagal update',false); }
      }catch(err){ toast('Error update: '+err.message,false); }
    }

    // ===== Init =====
    $(document).ready(function(){
      // Datepicker input form
      $("#inTanggal").datepicker({
        dateFormat:"dd/mm/yy",
        changeMonth:true,
        changeYear:true,
        yearRange:"2020:2030",
        showOn: "button",
        buttonText: ""
      });
      $("#inTanggal").val(fmtDDMMYYYY(new Date()));

      // Select tipe HP di form input
      $('#inTipehp').html(tipeHpOptions.map(v=>`<option>${v}</option>`).join(''));
      $('#inTipehp').select2({placeholder:"Pilih / ketik tipe HP",tags:true,width:'100%',createTag:(p)=>({id:p.term,text:p.term,newOption:true})});

      // Event form
      document.getElementById('formInput').addEventListener('submit', handleFormSubmit);
      document.getElementById('formCari').addEventListener('submit', handleSearchSubmit);
      document.getElementById('btnReset').addEventListener('click', handleSearchReset);

      // Checkbox override active loan
      document.getElementById('ignoreActiveLoan').addEventListener('change', function() {
        if (this.checked) {
          document.getElementById('btnSimpan').disabled = false;
          document.getElementById('npkWarning').classList.add('hidden');
          document.getElementById('warningContainer').classList.add('hidden');
        } else {
          cekNpkSaatInput();
        }
      });

      // Cek NPK saat input
      const inNpk = document.getElementById('inNpk');
      inNpk.addEventListener('blur', cekNpkSaatInput);
      inNpk.addEventListener('input', ()=>{
        clearTimeout(npkCheckTimer);
        npkCheckTimer = setTimeout(cekNpkSaatInput, 500);
      });

      // Datepicker di modal status
      $("#statusTanggal").datepicker({
        dateFormat:"dd/mm/yy",
        changeMonth:true,
        changeYear:true,
        yearRange:"2020:2030",
        showOn: "button",
        buttonText: ""
      });
    });

    AOS.init({duration:800,easing:'ease-out-cubic',once:true,offset:50});
  </script>
</body>
</html>
